---
title: "An√°lise de Sobreviv√™ncia e Confiabilidade<br>Sobrevida - Fiocruz: *AIDS Cl√°ssico*"
date: "Em: `r format(Sys.Date(), format='%d/%m/%Y')` | **Manaus/AM/BR** <br><br> Dados oriundos de:<br>*Carvalho MS, Andreozzi VL, Code√ßo CT, Campos DP, Barbosa MTS, Shimakura SE. An√°lise de sobreviv√™ncia: teoria e aplica√ß√µes em sa√∫de. Rio de Janeiro: Editora FIOCRUZ, 2011.*"
subtitle: "**Ariane Hayana Thom√© de Farias <br> Jo√£o Claudio da Silva Araujo Lobato**"
output:
  rmdformats::downcute:
    number_sections: false
    css: custom.css
    self_contained: true
    thumbnails: false
    lightbox: true
pkgdown:
  as_is: true
editor_options: 
 markdown: 
  wrap: 72
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(tidyverse)
library(survival)
library(plotly)
library(ggfortify)
opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               fig.align = "center",
               message = FALSE,
               warning = FALSE)
```


```{r include=FALSE}
ipec<-read.table("dados/ipec.csv",header=T,sep=";")
```


# **Introdu√ß√£o**

<center>![](https://s5.static.brasilescola.uol.com.br/be/2020/11/dia-mundial-de-luta-contra-a-aids.jpg)<center/>

Os dados s√£o provenientes de coortes hospitalares de pacientes portadores de HIV. A primeira coorte √© constitu√≠da dos pacientes portadores de HIV atendidos entre 1986 e 2000 no Instituto de Pesquisa Cl√≠nica Evandro Chagas (Ipec/Fiocruz). Dessa coorte, obteve-se uma amostra de 193 indiv√≠duos que foram diagnosticados como portadores de Aids (crit√©rio CDC 1993) durante o per√≠odo de acompanhamento.

# **Dicion√°rio de vari√°veis**

Para conhecermos as informa√ß√µes contidas na coorte em estudo, abaixo segue a lista de vari√°veis e suas respectivas descri√ß√µes. Note que o banco de dados possui  15 vari√°veis das quais, temos: `r names(ipec)`.

<center>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-vyl0{background-color:#8a4646;border-color:#ffffff;color:#FFF;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;font-weight:bold;text-align:center;vertical-align:middle}
.tg .tg-ja7q{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;font-style:italic;text-align:left;vertical-align:top}
.tg .tg-f9a0{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;font-weight:bold;text-align:center;vertical-align:top}
.tg .tg-wane{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;font-weight:bold;text-align:left;vertical-align:top}
.tg .tg-n7pz{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;text-align:center;vertical-align:middle}
.tg .tg-0zs5{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;text-align:left;vertical-align:middle}
.tg .tg-eox4{background-color:#8a4646;border-color:#ffffff;color:#ffffff;font-family:Verdana, Geneva, sans-serif !important;
  font-size:14px;font-weight:bold;text-align:center;vertical-align:middle}
</style>
<table class="tg">
<thead>
  <tr>
    <th class="tg-f9a0">Vari√°vel</th>
    <th class="tg-wane">Descri√ß√£o</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-n7pz"><b>id</b></td>
    <td class="tg-0zs5">Identifica√ß√£o do paciente</td>
  </tr>
  <tr>
    <td class="tg-eox4">ini</td>
    <td class="tg-0zs5">Data do diagn√≥stico da Aids (em dias)</td>
  </tr>
  <tr>
    <td class="tg-eox4">fim</td>
    <td class="tg-0zs5">Data do √≥bito (ou perda do paciente)</td>
  </tr>
  <tr>
    <td class="tg-eox4">tempo</td>
    <td class="tg-0zs5">Dias de sobreviv√™ncia do diagn√≥stico at√© o √≥bito</td>
  </tr>
  <tr>
    <td class="tg-eox4">status</td>
    <td class="tg-0zs5">0 = censura<br>1 = √≥bito</td>
  </tr>
  <tr>
    <td class="tg-eox4">sexo</td>
    <td class="tg-ja7q">F = feminino<br>M = masculino</td>
  </tr>
  <tr>
    <td class="tg-eox4">escola</td>
    <td class="tg-0zs5">0 = sem escolaridade<br>1 = ensino fundamental<br>2 = ensino m√©dio<br>3 = ensino superior</td>
  </tr>
  <tr>
    <td class="tg-eox4">idade</td>
    <td class="tg-0zs5">Idade na data do diagn√≥stico de Aids (20 a 68 anos)</td>
  </tr>
  <tr>
    <td class="tg-vyl0">risco</td>
    <td class="tg-0zs5">0 = homossexual masculino<br>1 = usu√°rio de drogas injet√°veis<br>2 = transfus√£o<br>3 = contato sexual com HIV+<br>5 = h√©tero c/m√∫ltiplos parceiros<br>6 = dois fatores de risco</td>
  </tr>
  <tr>
    <td class="tg-vyl0">acompan</td>
    <td class="tg-0zs5">Acompanhamento: <br>0 = ambulatorial/hospital-dia<br>1 = interna√ß√£o posterior<br>2 = interna√ß√£o imediata</td>
  </tr>
  <tr>
    <td class="tg-vyl0">obito</td>
    <td class="tg-ja7q">S = √≥bito<br>N = n√£o √≥bito<br>I = ignorado</td>
  </tr>
  <tr>
    <td class="tg-vyl0">anotrat</td>
    <td class="tg-0zs5">Ano do in√≠cio do tratamento (1990 a 2000), <br>sendo 9 = sem tratamento</td>
  </tr>
  <tr>
    <td class="tg-vyl0">tratam</td>
    <td class="tg-0zs5">Terapia antirretroviral:<br>0 = nenhum<br>1 = mono<br>2 = combinada<br>3 = potente</td>
  </tr>
  <tr>
    <td class="tg-vyl0">doenca</td>
    <td class="tg-0zs5">De apresenta√ß√£o: <br>1 = pcp<br>2 = pcp pulmonar<br>3 = pcp disseminada<br>4 = toxoplasmose<br>5 = sarcoma<br>7 = outra doen√ßa<br>8 = candid√≠ase<br>9 = duas doen√ßas<br>10 = herpes<br>99 = definido por cd4</td>
  </tr>
  <tr>
    <td class="tg-vyl0">propcp</td>
    <td class="tg-0zs5">Profilaxia para pneumocistis: <br>0 = sem profilaxia<br>2 = prim√°ria<br>3 = secund√°ria<br>4 = ambas</td>
  </tr>
</tbody>
</table>


</center>


Desta forma, podemos ent√£o visualizar previamente os dados:

```{r echo=FALSE}
ipec  %>%  
  DT::datatable()
```

Observa-se que o paciente `r ipec[1,1]` √© do sexo `r ifelse(ipec$sexo[1]=="M", "masculino", "feminino")`, tem `r ipec$idade[1]` anos e foi acompanhado por `r ipec$tempo[1]` dias at√© a data do seu √≥bito.


<br>

Conforme podemos observar, existem alguns dados faltantes na base de dados. Tamb√©m percebe-se que algumas informa√ß√µes precisam ser manipuladas conforme os objetivos do estudo. Segundo os autores, 

> - Na vari√°vel `doen√ßa` o 9 significa duas doen√ßas definidoras e 99 significa que o caso foi definido por CD4, por isso N√ÉO devem ser alterados. 
> - Na vari√°vel `anotrat` 9 indica a aus√™ncia de tratamento (paciente morre antes dos antirretrovirais) e n√£o missing.

Portanto, seguindo as observa√ß√µes mencionadas anteriormente, fez-se a substitui√ß√£o das informa√ß√µes ignoradas codificadas com `9/99` ou `I` por `NA`.


```{r}
ipec$anotrat[ipec$anotrat == 9] <- NA
ipec$obito[ipec$obito == "I"] <- NA
```

Outra parte importante na prepara√ß√£o dos dados consistiu em identificar se a classifica√ß√£o estava correta. Assim, identificamos que algumas vari√°veis estavam classificadas como num√©ricas em vez de categ√≥ricas, fez-se ent√£o altera√ß√µes nos dados conforme codifica√ß√£o correta das vari√°veis, obtendo-se os seguintes resultados:

```{r echo=FALSE}

ipec <- ipec %>% 
  mutate(sexo = as.factor(sexo),
         escola = as.factor(escola),
         risco = as.factor(risco),
         acompan = as.factor(acompan),
         obito = as.factor(obito),
         tratam = as.factor(tratam),
         doenca = as.factor(doenca),
         propcp = as.factor(propcp))

ipec %>% 
glimpse()

```


Com isso, podemos expressar a formula√ß√£o no formato cl√°ssico e de contagem no contexto da an√°lise de sobreviv√™ncia:


- No formato cl√°ssico, ser√°:

```{r echo=FALSE}
suv_class <- Surv(ipec$tempo, ipec$status);suv_class
```

- No formato de processo de contagem:

```{r echo=FALSE}
suv_cont <- Surv(ipec$ini, ipec$fim, ipec$status);suv_cont
```


Veja que, observando-se as sa√≠das nos dois formatos, se formos analisar o √∫ltimo paciente (o *193¬∫*), podemos inferir algumas informa√ß√µes:

* Processo cl√°ssico: `r Surv(ipec$tempo, ipec$status)[[193]]` dias de acompanhamento;
* Processo de contagem: in√≠cio do acompanhamento no `r Surv(ipec$ini, ipec$fim, ipec$status)[[193]]`¬∫ dia e fim no `r Surv(ipec$ini, ipec$fim, ipec$status)[[193,2]]`¬∫ dia do estudo (`r Surv(ipec$ini, ipec$fim, ipec$status)[[193,2]] - Surv(ipec$ini, ipec$fim, ipec$status)[[193]]` dias do processo cl√°ssico).
  * Status: √â censurado no seu √∫ltimo dia de acompanhamento. 



# **An√°lise explorat√≥ria e descritiva**

Para conhecer o perfil dos pacientes, bem como realizar uma an√°lise explorat√≥ria e descritiva dos dados, abaixo foram selecionados alguns pontos importantes.

`Selecione a vari√°vel desejada üîΩ`

### {.tabset .tabset-pills .tab}

#### Tempo

<center>

```{r echo=FALSE}

summary(ipec$tempo)

plot_ly(ipec, 
        y = ~tempo, type = "box", name = "Tempo")

```

</center>

Para a vari√°vel `Tempo`, podemos verificar que o tempo m√≠nimo de sobreviv√™ncia no per√≠odo considerado do diagn√≥stico at√© o √≥bito √© de 16 dias e o tempo m√°ximo de 3.228 dias. Ao avaliarmos a m√©dia e mediana, percebe-se que correspondem a 938,2 e 852,0, respectivamente.

<br>

#### Idade

<center>

```{r echo=FALSE}

summary(ipec$idade)

plot_ly(ipec, 
        y = ~idade, 
        type = "box", name = "Idade")

```

</center>

Para a vari√°vel `Idade`, podemos verificar que a idade m√≠nima dos pacientes √© de 20 anos e a m√°xima de 68 anos. Ao avaliarmos a m√©dia e mediana, percebe-se que a m√©dia de idade √© de 36,55 e a idade mediana de 35 anos.

<br>


#### Outros

A sumariza√ß√£o e medidas dos dados podem ser observadas no quadro abaixo:

<center>

```{r echo=FALSE}
summary(ipec) 
```

</center>



<br>


           
### Frequ√™ncia da escolaridade

```{r echo=FALSE}
totals_freq <- ipec %>% 
  group_by(escola) %>% 
  summarise(n = n())%>% 
  janitor::adorn_totals()

rownames(totals_freq) <- c("Sem escolaridade",
                  "Ensino fundamental",
                  "Ensino m√©dio",
                  "Ensino superior",
                  "N√£o informado",
                  " "
                  )

colnames(totals_freq) <- c("Escolaridade", "Qtd.")

totals_freq %>% kableExtra::kable()
```           
           
         
### Frequ√™ncia dos tratamentos

```{r echo=FALSE}
totals_freq_trat <- ipec %>% 
  group_by(tratam) %>% 
  summarise(n = n())%>% 
  janitor::adorn_totals()

rownames(totals_freq_trat) <- c("Nenhum", "Mono", "Combinada", "Potente", " ")

colnames(totals_freq_trat) <- c("Tratamentos", "Qtd.")

totals_freq_trat %>% kableExtra::kable()

```


### N√∫mero de eventos e censuras observadas

```{r echo=FALSE, warning=FALSE}
event_cens <- ipec %>% 
  group_by(status) %>% 
  summarise(n = n())%>% 
  janitor::adorn_totals()


colnames(event_cens) <- c("Status", "Qtd.")

rownames(event_cens) <- c("Censura", "√ìbito", " ")

event_cens %>% kableExtra::kable()

```
           
           
### N√∫mero de pacientes por escolaridade e por sexo

```{r echo=FALSE, warning=FALSE}

# Mulheres
ipec_f <- ipec %>% 
  select(escola, sexo) %>%
  filter(sexo == "F") %>% 
  group_by(escola) %>% 
  summarise(n = n()) %>% 
  janitor::adorn_totals()

# Homens
ipec_m <- ipec %>% 
  select(escola, sexo) %>%
  filter(sexo == "M") %>% 
  group_by(escola) %>% 
  summarise(n = n())%>% 
  janitor::adorn_totals()

totals_sexo <- left_join(ipec_f, ipec_m, by = "escola") 
colnames(totals_sexo) <- c("Escolaridade", "Feminino", "Masculino")

rownames(totals_sexo) <- c("Sem escolaridade",
                  "Ensino fundamental",
                  "Ensino m√©dio",
                  "Ensino superior",
                  "N√£o informado",
                  " "
                  )

totals_sexo %>% kableExtra::kable()

```


## Representa√ß√£o gr√°fica 

### Distribui√ß√£o das idades dos pacientes por g√™nero

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(ipec, 
        y = ~idade, 
        color = ~sexo, 
        type = "box")
```


<!-- ### Distribui√ß√£o dos tempos de sobreviv√™ncia -->

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- plot_ly(ipec, -->
<!--         x = ~tempo,  -->
<!--         type = "histogram") -->
<!-- ``` -->







# **Estimativas de Sobreviv√™ncia**

## Estimativas de Kaplan-Meier

```{r}
ipec<-read.table("dados/ipec.csv",header=T,sep=";")
# KM
km=survfit(Surv(ipec$tempo,ipec$status)~1)
km.table=fortify(km)

autoplot(km, surv.colour = '#2E9FDF', censor.colour = '#2E9FDF')+
  labs(x = "Tempo (dias)", y = "Probabilidade de Sobreviv√™ncia", 
       title = "Estimativas de Kaplan-Meier") + 
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold", colour="#873838", size = 12),
        axis.title.y = element_text(face="bold", colour="#873838", size = 12),
        legend.title = element_text(face="bold", size = 10))

```


## Estimativas de Nelson-Aalen


```{r}
# NA
na=survfit(coxph(Surv(ipec$tempo,ipec$status)~1))
na.table=fortify(na)

autoplot(na, surv.colour = '#FB7961', censor.colour = '#FB7961')+
  labs(x = "Tempo (dias)", y = "Probabilidade de Sobreviv√™ncia", 
       title = "Estimativas de Nelson-Aalen") + 
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold", colour="#873838", size = 12),
        axis.title.y = element_text(face="bold", colour="#873838", size = 12),
        legend.title = element_text(face="bold", size = 10))
```


```{r eval=FALSE, include=FALSE}
# tempo medio KM
kmi=km
#  C√≥digos no R para o c√°lculo do Tempo m√©dio
t=ipec$tempo[ipec$status==1]
tj=c(0,as.numeric(levels(as.factor(t))))
surv=c(1,as.numeric(levels(as.factor(kmi$surv))))
surv=sort(surv, decreasing=T)
k=length(tj)-1
prod=matrix(0,k,1)
for(j in 1:k){
  prod[j]<-(tj[j+1]-tj[j])*surv[j]
}
tm=sum(prod)

# tempo medio na
nai=na
#  C√≥digos no R para o c√°lculo do Tempo m√©dio
t=ipec$tempo[ipec$status==1]
tj=c(0,as.numeric(levels(as.factor(t))))
surv=c(1,as.numeric(levels(as.factor(nai$surv))))
surv=sort(surv, decreasing=T)
k=length(tj)-1
prod=matrix(0,k,1)
for(j in 1:k){
  prod[j]<-(tj[j+1]-tj[j])*surv[j]
}
tm=sum(prod)

#Tempo mediano
#km
#na
```

<br>

Com os gr√°ficos acima √© poss√≠vel notar que as estimativas de Kaplan-Meier e Nelson Aalen n√£o apresentam uma grande diferen√ßa. Em ambos os casos, para per√≠odos de at√© 1.000 dias, a probabilidade de sobreviv√™ncia se mant√©m acima de 50%. √â percept√≠vel tamb√©m que, entre 2.000 e 2.700 dias, a probabilidade de sobreviv√™ncia parece passar por uma estagna√ß√£o, tendo 42,23% de sobreviv√™ncia. No entanto quando expandimos o horizonte de dias, para uma quantidade maior que 2.700, as probabilidades de sobreviv√™ncia caem drasticamente, sendo inferior a 35%.



<br>


|                   | **Kaplan-Meier** | **Nelson Aalen** |
|-------------------|:----------------:|:----------------:|
| **Tempo M√©dio**   |     1603,062     |     1607,757     |
| **Tempo Mediano** |       1247       |       1247       |


<br>

Com rela√ß√£o aos tempos m√©dio e tempos medianos, √© poss√≠vel notar que h√° uma diferen√ßa apenas entre o tempo m√©dio, com as estimativas de Kaplan-Meier apresentando uma quantidade de dias inferior √† de Nelson Aalen, sendo 1603,062 e 1607,757 dias, respectivamente.


